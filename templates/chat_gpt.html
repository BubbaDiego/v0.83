{% extends "base.html" %}

{% block title %}ChatGPT Interface{% endblock %}


{% block extra_styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/title_bar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_themes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_titles.css') }}">
<style>

  body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 0;
  }

  .chat-container {
    max-width: 800px;
    margin: 2rem auto;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .chat-window {
    height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 5px;
    background-color: #fafafa;
    margin-bottom: 1rem;
  }
  .message {
    margin: 0.5rem 0;
    padding: 0.5rem;
    border-radius: 5px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .user-message {
    background-color: #dcf8c6;
    text-align: right;
    margin-left: auto;
  }
  .bot-message {
    background-color: #eee;
    text-align: left;
    margin-right: auto;
  }
  .input-area {
    display: flex;
  }
  .input-area input[type="text"] {
    flex: 1;
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .input-area button {
    padding: 0.5rem 1rem;
    margin-left: 0.5rem;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: #fff;
    cursor: pointer;
  }
  .input-area button:hover {
    background-color: #0056b3;
  }

  .oracle-panel {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
  }

  .oracle-output {
    min-height: 120px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 0.5rem;
    background: #fafafa;
    white-space: pre-wrap;
  }
</style>
{% endblock %}

{% block content %}
{% set title_text = 'ChatGPT' %}
{% include "title_bar.html" %}
<div class="chat-container">

  <h1>ChatGPT Interface</h1>

  <div id="infoPanel" style="margin-bottom: 1rem;">
    <p>Model: {{ model_name }}</p>
    <p id="tokenInfo"></p>
  </div>

  <div class="chat-window" id="chatWindow">
    <!-- Chat messages will appear here -->
  </div>
  <div class="input-area">
    <input type="text" id="userInput" placeholder="Type your message here..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<div class="oracle-panel sonic-content-panel mt-4">
  <div class="section-title icon-inline"><span>üßô</span><span>The Oracle</span></div>
  <div class="oracle-btns d-flex justify-content-around mb-3">
    <button class="oracle-btn btn btn-outline-primary" data-topic="portfolio" title="Ask about portfolio">üìÇ</button>
    <button class="oracle-btn btn btn-outline-secondary" data-topic="alerts" title="Ask about alerts">üö®</button>
    <button class="oracle-btn btn btn-outline-secondary" data-topic="prices" title="Ask about prices">üí≤</button>
    <button class="oracle-btn btn btn-outline-secondary" data-topic="system" title="Ask about system">üñ•Ô∏è</button>
  </div>
  <div id="oracleOutput" class="oracle-output"></div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/title_bar.js') }}" defer></script>
<script>

const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
const chatWindow = document.getElementById('chatWindow');
const tokenInfo = document.getElementById('tokenInfo');
const oracleOutput = document.getElementById('oracleOutput');
document.querySelectorAll('.oracle-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const topic = btn.dataset.topic;
    if (topic !== 'portfolio') {
      oracleOutput.textContent = 'Coming soon...';
      return;
    }
    try {
      const res = await fetch('{{ url_for('gpt_bp.ask_portfolio') }}');
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();
      oracleOutput.textContent = data.reply;
    } catch (err) {
      console.error('Error:', err);
      oracleOutput.textContent = 'Oops, something went wrong. Please try again.';
    }
  });
});

function addMessage(content, sender) {
  const div = document.createElement('div');
  div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
  div.textContent = content;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

sendBtn.addEventListener('click', async () => {
  const message = userInput.value.trim();
  if (!message) return;
  addMessage(message, 'user');
  userInput.value = '';

  try {
    const res = await fetch('{{ url_for('chat_gpt_bp.chat_post') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    if (!res.ok) throw new Error('Network response was not ok');
    const data = await res.json();
    addMessage(data.reply, 'bot');
    if (data.usage) {
      tokenInfo.textContent = `Prompt tokens: ${data.usage.prompt_tokens}, Completion tokens: ${data.usage.completion_tokens}, Total: ${data.usage.total_tokens}`;
    }
  } catch (err) {
    console.error('Error:', err);
    addMessage('Oops, something went wrong. Please try again.', 'bot');
  }
});

userInput.addEventListener('keypress', e => {
  if (e.key === 'Enter') sendBtn.click();
});

</script>
{% endblock %}

