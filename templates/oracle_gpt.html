{% extends "base.html" %}

{% block title %}The Oracle{% endblock %}

{% block extra_styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/title_bar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_themes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sonic_titles.css') }}">
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    background: url('{{ url_for('static', filename='images/oracle_wall.jpg') }}') no-repeat center center fixed;
    background-size: cover;
    color: #eee;
    overflow-x: hidden;
  }
  .oracle-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    backdrop-filter: none;
    position: relative;
  }
  .oracle-panel {
    background-color: rgba(20, 20, 30, 0.9);
    border: 2px solid #663399;
    padding: 20px;
    margin: 10px;
    border-radius: 15px;
    box-shadow: 0 0 20px #663399;
    width: 90%;
    max-width: 900px;
    position: relative;
    z-index: 2;
  }
  .oracle-title {
    font-size: 2rem;
    text-align: center;
    margin-bottom: 10px;
    color: #bb86fc;
    text-shadow: 0 0 8px #663399;
  }
  .select-group {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  select, input[type="text"] {
    padding: 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    flex: 1;
  }
  .oracle-output {
    background-color: #1c1c2b;
    padding: 15px;
    border-radius: 10px;
    margin-top: 10px;
    min-height: 100px;
  }
  .send-button, .quick-button {
    background-color: #bb86fc;
    color: #000;
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    font-size: 1rem;
    margin-top: 10px;
    margin-right: 10px;
    cursor: pointer;
    animation: pulse 2s infinite ease-in-out;
  }
  .send-button:hover, .quick-button:hover {
    background-color: #9b66dc;
  }
  .debug-panel {
    background-color: rgba(10, 10, 20, 0.85);
    border: 1px solid #555;
    padding: 15px;
    margin-top: 10px;
    border-radius: 10px;
    font-size: 0.9rem;
  }
  .debug-panel strong::after {
    content: " \2728";
    color: #f0f;
  }
  .quick-questions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 10px #bb86fc; }
    50% { box-shadow: 0 0 20px #ff9bff; }
    100% { box-shadow: 0 0 10px #bb86fc; }
  }
  .floating-runes {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    pointer-events: none;
    z-index: 1;
  }
  .floating-rune {
    position: absolute;
    font-size: 1.5rem;
    color: rgba(255, 255, 255, 0.2);
    animation: float 10s linear infinite;
  }
  @keyframes float {
    0% { transform: translateY(100vh) translateX(0); }
    100% { transform: translateY(-10vh) translateX(20px); }
  }
</style>
{% endblock %}

{% block content %}
{% set title_text = 'The Oracle' %}
{% include "title_bar.html" %}
<div class="oracle-container">
  <div class="floating-runes">
    <div class="floating-rune" style="left: 10%; animation-delay: 0s;">‚ú¶</div>
    <div class="floating-rune" style="left: 30%; animation-delay: 2s;">·ö†</div>
    <div class="floating-rune" style="left: 50%; animation-delay: 4s;">‚öù</div>
    <div class="floating-rune" style="left: 70%; animation-delay: 6s;">‚òÑ</div>
    <div class="floating-rune" style="left: 90%; animation-delay: 8s;">·õÉ</div>
  </div>
  <div class="oracle-panel">
    <div class="oracle-title">üîÆ Speak to the Oracle</div>
    <div class="select-group">
      <select id="persona-select">
        <option value="Selena" title="üßù Conservative and careful strategist">üßù Selena (Conservative)</option>
        <option value="Nina" title="üßô Balanced, data-driven oracle mind">üßô Nina (Neutral)</option>
        <option value="Angie" title="üßõ Bold risk-taker with sharp instincts">üßõ Angie (Aggressive)</option>
        <option value="Wizard" title="üßô\u200d‚ôÇÔ∏è Mystical risk wizard">üßô\u200d‚ôÇÔ∏è Wizard (Experimental)</option>
      </select>
      <select id="voice-select">
        <option value="">Default Voice</option>
      </select>
    </div>
    <input type="text" id="oracle-query" placeholder="Speak your query...">
    <button class="send-button" id="sendBtn">üì® Send</button>
    <div class="quick-questions">
      <button class="quick-button" onclick="quickAsk('portfolio')">üìÅ Portfolio Status</button>
      <button class="quick-button" onclick="quickAsk('alerts')">üö® Alert Status</button>
      <button class="quick-button" onclick="quickAsk('prices')">üí∞ Market Prices</button>
      <button class="quick-button" onclick="quickAsk('system')">üñ•Ô∏è System Health</button>
      <button class="quick-button" onclick="quickAsk('positions')">üìä Position Status</button>
    </div>
    <div class="oracle-output" id="oracle-output">Ask a question to receive wisdom from the stars.</div>
    <div class="debug-panel" id="debug-panel">
      <strong>Persona:</strong> <span id="debug-persona">Angie</span><br />
      <strong>Profile:</strong> Aggressive<br />
      <strong>Strategies:</strong> üíπ Dynamic Hedging (30%), üíé Profit Management (20%)<br />
      <strong>Overview:</strong> Prioritizes aggressive returns with minimal hedging delay and less restrictive profit locks.
      <br />
      <strong>Voice:</strong> <span id="debug-voice">Default</span>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/title_bar.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/sonic_theme_toggle.js') }}"></script>
<script src="{{ url_for('static', filename='js/layout_mode.js') }}"></script>
<script>
  let currentTopic = 'portfolio';

  const personaSelect = document.getElementById('persona-select');
  const voiceSelect = document.getElementById('voice-select');

  personaSelect.addEventListener('change', updateDebug);
  voiceSelect.addEventListener('change', updateVoiceDebug);
  document.getElementById('sendBtn').addEventListener('click', askOracle);

  function populateVoices() {
    if (!window.speechSynthesis) return;
    const voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
    voiceSelect.innerHTML = '<option value="">Default Voice</option>' +
      voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    const preferred = voices.find(v => v.name === 'Google UK English Female');
    if (preferred) {
      voiceSelect.value = preferred.name;
    }
    updateVoiceDebug();
  }

  speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();

  function updateDebug() {
    const persona = personaSelect.value;
    document.getElementById('debug-persona').textContent = persona;
  }

  function updateVoiceDebug() {
    const voice = voiceSelect.value || 'Default';
    document.getElementById('debug-voice').textContent = voice;
  }

  function quickAsk(topic) {
    currentTopic = topic;
    document.getElementById('oracle-query').value = '';
    askOracle('');
  }

  function askOracle(queryOverride) {
    const persona = personaSelect.value;
    const query =
      queryOverride !== undefined
        ? queryOverride
        : document.getElementById('oracle-query').value.trim();
    const url = `/gpt/oracle/query?persona=${encodeURIComponent(persona)}&topic=${encodeURIComponent(currentTopic)}&query=${encodeURIComponent(query)}`;
    fetch(url)
      .then(res => res.json())
      .then(data => {
        const output = document.getElementById('oracle-output');
        const reply = data.reply || data.error || 'No response';
        output.textContent = reply;
        speakResponse(reply);
      })
      .catch(err => {
        document.getElementById('oracle-output').textContent = 'Error: ' + err.message;
      });
  }

  function speakResponse(text) {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.pitch = 1.1;
    utterance.rate = 0.92;
    utterance.volume = 1;
    const selectedName = voiceSelect.value;
    const voices = speechSynthesis.getVoices();
    const defaultVoice = voices.find(v => v.name === 'Google UK English Female') ||
      voices.find(v => v.name.includes('Whisper') || v.name.includes('Zira') || v.lang.includes('en'));
    utterance.voice = speechSynthesis.getVoices().find(v => v.name === selectedName) || defaultVoice;
    speechSynthesis.speak(utterance);
  }
</script>
{% endblock %}
